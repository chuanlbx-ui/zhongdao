name: Deploy Production

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Image tag to deploy"
        required: true
        default: "latest"
      target_env:
        description: "Target environment"
        required: true
        default: "prod"
        type: choice
        options:
          - prod
          - staging

jobs:
  deploy:
    name: Deploy with health-check and rollback (self-hosted)
    runs-on: [self-hosted, linux, zhongdao-deploy]
    environment: ${{ inputs.target_env == 'prod' && 'production' || 'staging' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate runner prerequisites
        run: |
          command -v bash
          command -v docker
          docker --version
          docker compose version

      - name: Validate deployment path
        run: |
          test -n "${{ secrets.DEPLOY_PATH }}"
          mkdir -p "${{ secrets.DEPLOY_PATH }}"

      - name: Prepare deployment directories
        run: |
          DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"
          mkdir -p "$DEPLOY_PATH/ops/compose"
          mkdir -p "$DEPLOY_PATH/ops/scripts"
          mkdir -p "$DEPLOY_PATH/config/env"
          mkdir -p "$DEPLOY_PATH/logs/api"
          mkdir -p "$DEPLOY_PATH/logs/api-staging"
          mkdir -p "$DEPLOY_PATH/ops/.state"

      - name: Sync deployment assets on local server
        run: |
          DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"

          cp -a ops/compose/. "$DEPLOY_PATH/ops/compose/"
          cp -a ops/scripts/. "$DEPLOY_PATH/ops/scripts/"
          chmod +x "$DEPLOY_PATH/ops/scripts/"*.sh

          # Only copy templates and schema. Real .env files stay server-local.
          cp -f config/env/.env.example "$DEPLOY_PATH/config/env/.env.example"
          cp -f config/env/.env.staging.example "$DEPLOY_PATH/config/env/.env.staging.example"
          cp -f config/env/.env.prod.example "$DEPLOY_PATH/config/env/.env.prod.example"
          cp -f config/env/env.schema.json "$DEPLOY_PATH/config/env/env.schema.json"

      - name: Validate target env file exists
        run: |
          DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"
          if [ "${{ inputs.target_env }}" = "prod" ]; then
            API_ENV_FILE="$DEPLOY_PATH/config/env/.env.prod"
          else
            API_ENV_FILE="$DEPLOY_PATH/config/env/.env.staging"
          fi
          test -f "$API_ENV_FILE"

      - name: Run deployment
        run: |
          DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"
          if [ "${{ inputs.target_env }}" = "prod" ]; then
            API_ENV_FILE="$DEPLOY_PATH/config/env/.env.prod"
          else
            API_ENV_FILE="$DEPLOY_PATH/config/env/.env.staging"
          fi
          cd "$DEPLOY_PATH"
          API_ENV_FILE="$API_ENV_FILE" bash ops/scripts/deploy.sh --env "${{ inputs.target_env }}" --image-tag "${{ inputs.image_tag }}"

      - name: Health check after deployment
        run: |
          DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"
          if [ "${{ inputs.target_env }}" = "prod" ]; then
            HEALTH_URL="http://127.0.0.1:3000/health"
          else
            HEALTH_URL="http://127.0.0.1:3001/health"
          fi
          cd "$DEPLOY_PATH"
          HEALTH_URL="$HEALTH_URL" bash ops/scripts/health-check.sh --env "${{ inputs.target_env }}"

      - name: Auto rollback on failure
        if: failure()
        run: |
          DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"
          if [ "${{ inputs.target_env }}" = "prod" ]; then
            API_ENV_FILE="$DEPLOY_PATH/config/env/.env.prod"
          else
            API_ENV_FILE="$DEPLOY_PATH/config/env/.env.staging"
          fi
          cd "$DEPLOY_PATH"
          API_ENV_FILE="$API_ENV_FILE" bash ops/scripts/rollback.sh --env "${{ inputs.target_env }}" --to previous
